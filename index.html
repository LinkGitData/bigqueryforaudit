<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>實驗室指南：使用 BigQuery 與 Cloud Logging 分析 BigQuery 使用情況</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }
        h1, h2, h3 {
            font-weight: 700;
            color: #f9fafb; /* text-gray-50 */
        }
        code {
            background-color: #374151; /* bg-gray-700 */
            color: #e5e7eb; /* text-gray-200 */
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 0.9em;
            border-radius: 0.3rem;
        }
        pre {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #4b5563; /* border-gray-600 */
            border-radius: 0.5rem;
            padding: 1rem;
            position: relative;
            overflow-x: auto;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            margin: 0;
            font-size: 1em;
        }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #4b5563; /* bg-gray-600 */
            color: #e5e7eb; /* text-gray-200 */
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: #6b7280; /* bg-gray-500 */
        }
        .mermaid {
            background-color: #1f2937; /* bg-gray-800 */
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-2 text-cyan-400">實驗室指南 📊</h1>
            <p class="text-xl text-gray-200">使用 BigQuery 與 Cloud Logging 分析 BigQuery 使用情況</p>
            <p class="mt-4 text-gray-400">本指南將引導您如何利用 Cloud Logging 來檢視 BigQuery 的使用日誌，並設定一個匯出槽 (sink)，將這些日誌永久儲存到 BigQuery 中進行長期分析。</p>
        </header>

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">實驗流程圖</h2>
            <div class="mermaid">
                graph TD
                    A[🚀 任務 3: 在 BigQuery 中執行查詢以產生日誌] --> B[📝 任務 4: 前往 Cloud Logging 尋找日誌];
                    B --> C[🔧 任務 4: 建立匯出槽(Sink)將日誌匯出至 BigQuery];
                    C --> D[🔄 任務 5: 執行更多範例查詢以產生新日誌];
                    D --> E[👁️ 任務 6: 回到 BigQuery 檢視匯入的日誌];
                    E --> F[✨ 任務 6: 建立一個 VIEW 來簡化日誌資料];
                    F --> G[📈 任務 6: 查詢 VIEW 以分析使用情況];
            </div>
        </section>

        <hr class="border-gray-700 my-8">

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">任務 1 & 2：前置作業與建立資料集</h2>
            <p class="mb-4 text-gray-400">首先，我們需要一個地方來存放從 Cloud Logging 匯出的日誌。</p>
            <div class="space-y-4">
                <div>
                    <h3 class="text-xl font-semibold mb-2">1. 開啟 BigQuery</h3>
                    <p>在 Google Cloud Console 中，透過導覽選單 (<strong>Navigation menu</strong>) 進入 <strong>BigQuery</strong>。</p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">2. 建立資料集 (Dataset)</h3>
                    <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-300">
                        <li>在 <strong>Explorer</strong> 面板中，找到您的專案 (名稱以 <code>qwiklabs-gcp-</code> 開頭)，點擊旁邊的三個點。</li>
                        <li>選擇 <strong>Create dataset</strong>。</li>
                        <li>設定 <strong>Dataset ID</strong> 為 <code>bq_logs</code>。</li>
                        <li>點擊 <strong>Create Dataset</strong>。</li>
                    </ol>
                </div>
            </div>
        </section>

        <hr class="border-gray-700 my-8">

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">任務 3：執行一筆查詢以產生紀錄</h2>
            <p class="mb-4 text-gray-400">為了讓我們在 Cloud Logging 中能看到東西，先來執行一筆簡單的查詢。</p>
            <ol class="list-decimal list-inside space-y-2 pl-4 mb-4 text-gray-300">
                <li>將以下查詢複製並貼到 BigQuery <strong>查詢編輯器 (Query editor)</strong> 中：</li>
            </ol>
            <pre><code>SELECT current_date</code></pre>
            <ol class="list-decimal list-inside space-y-2 pl-4 mt-4 text-gray-300" start="2">
                <li>點擊 <strong>RUN</strong>。</li>
            </ol>
        </section>

        <hr class="border-gray-700 my-8">

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">任務 4：設定從 Cloud Logging 匯出日誌</h2>
            <p class="mb-4 text-gray-400">現在，我們將設定一個「匯出槽」(Sink)，它會自動把符合條件的日誌從 Cloud Logging 傳送到我們剛建立的 BigQuery 資料集。</p>
            <div class="space-y-4">
                <div>
                    <h3 class="text-xl font-semibold mb-2">1. 前往 Logs Explorer</h3>
                    <p>在導覽選單中，選擇 <strong>Logging > Logs Explorer</strong>。</p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">2. 篩選 BigQuery 日誌</h3>
                    <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-300">
                        <li>在 <strong>Resource</strong> 下拉選單中，選擇 <strong>BigQuery</strong>，然後點擊 <strong>Apply</strong>。</li>
                        <li>點擊右上角的 <strong>Run query</strong>。您應該會看到剛剛執行查詢所產生的日誌。</li>
                        <li>找到包含 <code>jobservice.jobcompleted</code> 的日誌條目，點擊它，然後選擇 <strong>Show matching entries</strong>。這會自動幫您設定好篩選條件。</li>
                    </ol>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">3. 建立匯出槽 (Create Sink)</h3>
                    <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-300">
                        <li>在右上角的 <strong>Actions</strong> 下拉選單中，點擊 <strong>Create sink</strong>。</li>
                        <li><strong>Sink name</strong>: 輸入 <code>JobComplete</code>，然後點擊 <strong>NEXT</strong>。</li>
                        <li><strong>Select sink service</strong>: 選擇 <strong>BigQuery dataset</strong>。</li>
                        <li><strong>Select BigQuery dataset (Destination)</strong>: 選擇我們剛剛建立的 <code>bq_logs</code>。</li>
                        <li>保留其餘設定為預設值，點擊 <strong>Create Sink</strong>。</li>
                    </ol>
                </div>
            </div>
        </section>

        <hr class="border-gray-700 my-8">

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">任務 5：執行範例查詢以填充日誌</h2>
            <p class="mb-4 text-gray-400">為了讓新的日誌中有資料可供分析，請執行以下幾個查詢。</p>
            <ol class="list-decimal list-inside space-y-2 pl-4 mb-4 text-gray-300">
                <li>開啟 <strong>Cloud Shell</strong>。</li>
                <li>將以下 <code>bq</code> 指令<strong>逐一</strong>複製貼上到 Cloud Shell 中並執行。</li>
            </ol>
            <div class="space-y-6">
                <div>
                    <h4 class="font-semibold text-lg text-gray-200">查詢一：</h4>
                    <pre><code>bq query --location=us --use_legacy_sql=false --use_cache=false 'SELECT fullName, AVG(CL.numberOfYears) avgyears FROM `qwiklabs-resources.qlbqsamples.persons_living`, UNNEST(citiesLived) as CL GROUP BY fullname'</code></pre>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-200">查詢二：</h4>
                    <pre><code>bq query --location=us --use_legacy_sql=false --use_cache=false 'select month, avg(mean_temp) as avgtemp from `qwiklabs-resources.qlweather_geo.gsod` where station_number = 947680 and year = 2010 group by month order by month'</code></pre>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-200">查詢三：</h4>
                    <pre><code>bq query --location=us --use_legacy_sql=false --use_cache=false 'select CONCAT(departure_airport, "-", arrival_airport) as route, count(*) as numberflights from `bigquery-samples.airline_ontime_data.airline_id_codes` ac, `qwiklabs-resources.qlairline_ontime_data.flights` fl where ac.code = fl.airline_code and regexp_contains(ac.airline , r"Alaska") group by 1 order by 2 desc LIMIT 10'</code></pre>
                </div>
            </div>
        </section>

        <hr class="border-gray-700 my-8">

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">任務 6：在 BigQuery 中檢視與分析日誌</h2>
            <p class="mb-4 text-gray-400">日誌已經透過 Sink 進入 BigQuery，現在讓我們來看看成果。</p>
            <div class="space-y-4">
                <div>
                    <h3 class="text-xl font-semibold mb-2">1. 尋找日誌資料表</h3>
                    <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-300">
                        <li>回到 <strong>BigQuery</strong> 介面。</li>
                        <li>在 <strong>Explorer</strong> 面板中，展開您的專案及 <code>bq_logs</code> 資料集。</li>
                        <li>您會看到一個新建立的資料表，名稱類似 <code>cloudaudit_googleapis_com_data_access_...</code>。</li>
                        <li class="text-amber-300"><strong>注意：</strong> 日誌是透過串流方式寫入的，所以點擊 <strong>Preview</strong> 可能暫時看不到最新資料，但資料已經可以被查詢。</li>
                    </ol>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">2. 建立 VIEW 簡化資料</h3>
                    <p class="mb-4 text-gray-400">原始的日誌資料表欄位非常多且複雜。為了方便分析，我們建立一個 <strong>VIEW (檢視表)</strong> 來抽取重要欄位並做一些基本計算。</p>
                    <ol class="list-decimal list-inside space-y-2 pl-4 mb-4 text-gray-300">
                        <li>點擊 <strong>+ (Compose new query)</strong>，貼上並執行以下 SQL：</li>
                    </ol>
                    <div class="bg-yellow-900/30 border border-yellow-600 text-yellow-300 px-4 py-3 rounded-lg relative mb-4" role="alert">
                      <strong class="font-bold">⚠️ 重要提示：</strong>
                      <span class="block sm:inline">請務必將 <code>Project ID</code> 替換為您實驗室的<strong>實際專案 ID</strong>。</span>
                    </div>
                    <pre><code class="language-sql">CREATE OR REPLACE VIEW
  bq_logs.v_querylogs AS
SELECT
  resource.labels.project_id,
  protopayload_auditlog.authenticationInfo.principalEmail,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobConfiguration.query.query,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobConfiguration.query.statementType,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatus.error.message,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.startTime,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.endTime,
  TIMESTAMP_DIFF(protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.endTime, protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.startTime, MILLISECOND)/1000 AS run_seconds,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.totalProcessedBytes,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.totalSlotMs,
  ARRAY(SELECT as STRUCT datasetid, tableId FROM UNNEST(protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.referencedTables)) as tables_ref,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.totalTablesProcessed,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.queryOutputRowCount,
  severity
FROM
  `Project ID.bq_logs.cloudaudit_googleapis_com_data_access_*`
ORDER BY
  startTime</code></pre>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">3. 查詢 VIEW</h3>
                    <p class="mb-4 text-gray-400">現在，您可以像查詢一般資料表一樣，查詢這個 <code>v_querylogs</code> 檢視表了。撰寫一個新查詢並執行：</p>
                    <pre><code>SELECT * FROM bq_logs.v_querylogs</code></pre>
                    <p class="mt-4 text-gray-300">在查詢結果中，您可以看到被整理過的日誌，包含執行者、查詢語句、開始與結束時間、執行秒數等實用資訊。</p>
                </div>
            </div>
        </section>

        <footer class="text-center mt-12 py-6 border-t border-gray-700">
            <p class="text-lg font-semibold text-green-400">恭喜您！🎉</p>
            <p class="text-gray-400">您已成功建立一個自動化的 BigQuery 使用情況分析流程。</p>
        </footer>

    </div>

    <script>
        // 初始化 Mermaid.js
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });

        // 為所有 <pre> 區塊加上複製按鈕
        document.querySelectorAll('pre').forEach(pre => {
            const code = pre.querySelector('code');
            if (code) {
                const button = document.createElement('button');
                button.innerText = '複製';
                button.className = 'copy-btn';
                
                button.addEventListener('click', () => {
                    const textToCopy = code.innerText;
                    
                    // 使用 Clipboard API
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        button.innerText = '已複製!';
                        setTimeout(() => {
                            button.innerText = '複製';
                        }, 2000);
                    }).catch(err => {
                        console.error('無法複製文字: ', err);
                        // 備用方法
                        const textArea = document.createElement('textarea');
                        textArea.value = textToCopy;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            button.innerText = '已複製!';
                            setTimeout(() => {
                                button.innerText = '複製';
                            }, 2000);
                        } catch (e) {
                            button.innerText = '失敗';
                        }
                        document.body.removeChild(textArea);
                    });
                });
                
                pre.appendChild(button);
            }
        });
    </script>

</body>
</html>
