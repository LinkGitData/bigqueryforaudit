<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦é©—å®¤æŒ‡å—ï¼šä½¿ç”¨ BigQuery èˆ‡ Cloud Logging åˆ†æ BigQuery ä½¿ç”¨æƒ…æ³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }
        h1, h2, h3 {
            font-weight: 700;
            color: #f9fafb; /* text-gray-50 */
        }
        code {
            background-color: #374151; /* bg-gray-700 */
            color: #e5e7eb; /* text-gray-200 */
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 0.9em;
            border-radius: 0.3rem;
        }
        pre {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #4b5563; /* border-gray-600 */
            border-radius: 0.5rem;
            padding: 1rem;
            position: relative;
            overflow-x: auto;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            margin: 0;
            font-size: 1em;
        }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #4b5563; /* bg-gray-600 */
            color: #e5e7eb; /* text-gray-200 */
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: #6b7280; /* bg-gray-500 */
        }
        .mermaid {
            background-color: #1f2937; /* bg-gray-800 */
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-2 text-cyan-400">å¯¦é©—å®¤æŒ‡å— ğŸ“Š</h1>
            <p class="text-xl text-gray-200">ä½¿ç”¨ BigQuery èˆ‡ Cloud Logging åˆ†æ BigQuery ä½¿ç”¨æƒ…æ³</p>
            <p class="mt-4 text-gray-400">æœ¬æŒ‡å—å°‡å¼•å°æ‚¨å¦‚ä½•åˆ©ç”¨ Cloud Logging ä¾†æª¢è¦– BigQuery çš„ä½¿ç”¨æ—¥èªŒï¼Œä¸¦è¨­å®šä¸€å€‹åŒ¯å‡ºæ§½ (sink)ï¼Œå°‡é€™äº›æ—¥èªŒæ°¸ä¹…å„²å­˜åˆ° BigQuery ä¸­é€²è¡Œé•·æœŸåˆ†æã€‚</p>
        </header>

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">å¯¦é©—æµç¨‹åœ–</h2>
            <div class="mermaid">
                graph TD
                    A[ğŸš€ ä»»å‹™ 3: åœ¨ BigQuery ä¸­åŸ·è¡ŒæŸ¥è©¢ä»¥ç”¢ç”Ÿæ—¥èªŒ] --> B[ğŸ“ ä»»å‹™ 4: å‰å¾€ Cloud Logging å°‹æ‰¾æ—¥èªŒ];
                    B --> C[ğŸ”§ ä»»å‹™ 4: å»ºç«‹åŒ¯å‡ºæ§½(Sink)å°‡æ—¥èªŒåŒ¯å‡ºè‡³ BigQuery];
                    C --> D[ğŸ”„ ä»»å‹™ 5: åŸ·è¡Œæ›´å¤šç¯„ä¾‹æŸ¥è©¢ä»¥ç”¢ç”Ÿæ–°æ—¥èªŒ];
                    D --> E[ğŸ‘ï¸ ä»»å‹™ 6: å›åˆ° BigQuery æª¢è¦–åŒ¯å…¥çš„æ—¥èªŒ];
                    E --> F[âœ¨ ä»»å‹™ 6: å»ºç«‹ä¸€å€‹ VIEW ä¾†ç°¡åŒ–æ—¥èªŒè³‡æ–™];
                    F --> G[ğŸ“ˆ ä»»å‹™ 6: æŸ¥è©¢ VIEW ä»¥åˆ†æä½¿ç”¨æƒ…æ³];
            </div>
        </section>

        <hr class="border-gray-700 my-8">

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">ä»»å‹™ 1 & 2ï¼šå‰ç½®ä½œæ¥­èˆ‡å»ºç«‹è³‡æ–™é›†</h2>
            <p class="mb-4 text-gray-400">é¦–å…ˆï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹åœ°æ–¹ä¾†å­˜æ”¾å¾ Cloud Logging åŒ¯å‡ºçš„æ—¥èªŒã€‚</p>
            <div class="space-y-4">
                <div>
                    <h3 class="text-xl font-semibold mb-2">1. é–‹å•Ÿ BigQuery</h3>
                    <p>åœ¨ Google Cloud Console ä¸­ï¼Œé€éå°è¦½é¸å–® (<strong>Navigation menu</strong>) é€²å…¥ <strong>BigQuery</strong>ã€‚</p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">2. å»ºç«‹è³‡æ–™é›† (Dataset)</h3>
                    <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-300">
                        <li>åœ¨ <strong>Explorer</strong> é¢æ¿ä¸­ï¼Œæ‰¾åˆ°æ‚¨çš„å°ˆæ¡ˆ (åç¨±ä»¥ <code>qwiklabs-gcp-</code> é–‹é ­)ï¼Œé»æ“Šæ—é‚Šçš„ä¸‰å€‹é»ã€‚</li>
                        <li>é¸æ“‡ <strong>Create dataset</strong>ã€‚</li>
                        <li>è¨­å®š <strong>Dataset ID</strong> ç‚º <code>bq_logs</code>ã€‚</li>
                        <li>é»æ“Š <strong>Create Dataset</strong>ã€‚</li>
                    </ol>
                </div>
            </div>
        </section>

        <hr class="border-gray-700 my-8">

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">ä»»å‹™ 3ï¼šåŸ·è¡Œä¸€ç­†æŸ¥è©¢ä»¥ç”¢ç”Ÿç´€éŒ„</h2>
            <p class="mb-4 text-gray-400">ç‚ºäº†è®“æˆ‘å€‘åœ¨ Cloud Logging ä¸­èƒ½çœ‹åˆ°æ±è¥¿ï¼Œå…ˆä¾†åŸ·è¡Œä¸€ç­†ç°¡å–®çš„æŸ¥è©¢ã€‚</p>
            <ol class="list-decimal list-inside space-y-2 pl-4 mb-4 text-gray-300">
                <li>å°‡ä»¥ä¸‹æŸ¥è©¢è¤‡è£½ä¸¦è²¼åˆ° BigQuery <strong>æŸ¥è©¢ç·¨è¼¯å™¨ (Query editor)</strong> ä¸­ï¼š</li>
            </ol>
            <pre><code>SELECT current_date</code></pre>
            <ol class="list-decimal list-inside space-y-2 pl-4 mt-4 text-gray-300" start="2">
                <li>é»æ“Š <strong>RUN</strong>ã€‚</li>
            </ol>
        </section>

        <hr class="border-gray-700 my-8">

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">ä»»å‹™ 4ï¼šè¨­å®šå¾ Cloud Logging åŒ¯å‡ºæ—¥èªŒ</h2>
            <p class="mb-4 text-gray-400">ç¾åœ¨ï¼Œæˆ‘å€‘å°‡è¨­å®šä¸€å€‹ã€ŒåŒ¯å‡ºæ§½ã€(Sink)ï¼Œå®ƒæœƒè‡ªå‹•æŠŠç¬¦åˆæ¢ä»¶çš„æ—¥èªŒå¾ Cloud Logging å‚³é€åˆ°æˆ‘å€‘å‰›å»ºç«‹çš„ BigQuery è³‡æ–™é›†ã€‚</p>
            <div class="space-y-4">
                <div>
                    <h3 class="text-xl font-semibold mb-2">1. å‰å¾€ Logs Explorer</h3>
                    <p>åœ¨å°è¦½é¸å–®ä¸­ï¼Œé¸æ“‡ <strong>Logging > Logs Explorer</strong>ã€‚</p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">2. ç¯©é¸ BigQuery æ—¥èªŒ</h3>
                    <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-300">
                        <li>åœ¨ <strong>Resource</strong> ä¸‹æ‹‰é¸å–®ä¸­ï¼Œé¸æ“‡ <strong>BigQuery</strong>ï¼Œç„¶å¾Œé»æ“Š <strong>Apply</strong>ã€‚</li>
                        <li>é»æ“Šå³ä¸Šè§’çš„ <strong>Run query</strong>ã€‚æ‚¨æ‡‰è©²æœƒçœ‹åˆ°å‰›å‰›åŸ·è¡ŒæŸ¥è©¢æ‰€ç”¢ç”Ÿçš„æ—¥èªŒã€‚</li>
                        <li>æ‰¾åˆ°åŒ…å« <code>jobservice.jobcompleted</code> çš„æ—¥èªŒæ¢ç›®ï¼Œé»æ“Šå®ƒï¼Œç„¶å¾Œé¸æ“‡ <strong>Show matching entries</strong>ã€‚é€™æœƒè‡ªå‹•å¹«æ‚¨è¨­å®šå¥½ç¯©é¸æ¢ä»¶ã€‚</li>
                    </ol>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">3. å»ºç«‹åŒ¯å‡ºæ§½ (Create Sink)</h3>
                    <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-300">
                        <li>åœ¨å³ä¸Šè§’çš„ <strong>Actions</strong> ä¸‹æ‹‰é¸å–®ä¸­ï¼Œé»æ“Š <strong>Create sink</strong>ã€‚</li>
                        <li><strong>Sink name</strong>: è¼¸å…¥ <code>JobComplete</code>ï¼Œç„¶å¾Œé»æ“Š <strong>NEXT</strong>ã€‚</li>
                        <li><strong>Select sink service</strong>: é¸æ“‡ <strong>BigQuery dataset</strong>ã€‚</li>
                        <li><strong>Select BigQuery dataset (Destination)</strong>: é¸æ“‡æˆ‘å€‘å‰›å‰›å»ºç«‹çš„ <code>bq_logs</code>ã€‚</li>
                        <li>ä¿ç•™å…¶é¤˜è¨­å®šç‚ºé è¨­å€¼ï¼Œé»æ“Š <strong>Create Sink</strong>ã€‚</li>
                    </ol>
                </div>
            </div>
        </section>

        <hr class="border-gray-700 my-8">

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">ä»»å‹™ 5ï¼šåŸ·è¡Œç¯„ä¾‹æŸ¥è©¢ä»¥å¡«å……æ—¥èªŒ</h2>
            <p class="mb-4 text-gray-400">ç‚ºäº†è®“æ–°çš„æ—¥èªŒä¸­æœ‰è³‡æ–™å¯ä¾›åˆ†æï¼Œè«‹åŸ·è¡Œä»¥ä¸‹å¹¾å€‹æŸ¥è©¢ã€‚</p>
            <ol class="list-decimal list-inside space-y-2 pl-4 mb-4 text-gray-300">
                <li>é–‹å•Ÿ <strong>Cloud Shell</strong>ã€‚</li>
                <li>å°‡ä»¥ä¸‹ <code>bq</code> æŒ‡ä»¤<strong>é€ä¸€</strong>è¤‡è£½è²¼ä¸Šåˆ° Cloud Shell ä¸­ä¸¦åŸ·è¡Œã€‚</li>
            </ol>
            <div class="space-y-6">
                <div>
                    <h4 class="font-semibold text-lg text-gray-200">æŸ¥è©¢ä¸€ï¼š</h4>
                    <pre><code>bq query --location=us --use_legacy_sql=false --use_cache=false 'SELECT fullName, AVG(CL.numberOfYears) avgyears FROM `qwiklabs-resources.qlbqsamples.persons_living`, UNNEST(citiesLived) as CL GROUP BY fullname'</code></pre>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-200">æŸ¥è©¢äºŒï¼š</h4>
                    <pre><code>bq query --location=us --use_legacy_sql=false --use_cache=false 'select month, avg(mean_temp) as avgtemp from `qwiklabs-resources.qlweather_geo.gsod` where station_number = 947680 and year = 2010 group by month order by month'</code></pre>
                </div>
                <div>
                    <h4 class="font-semibold text-lg text-gray-200">æŸ¥è©¢ä¸‰ï¼š</h4>
                    <pre><code>bq query --location=us --use_legacy_sql=false --use_cache=false 'select CONCAT(departure_airport, "-", arrival_airport) as route, count(*) as numberflights from `bigquery-samples.airline_ontime_data.airline_id_codes` ac, `qwiklabs-resources.qlairline_ontime_data.flights` fl where ac.code = fl.airline_code and regexp_contains(ac.airline , r"Alaska") group by 1 order by 2 desc LIMIT 10'</code></pre>
                </div>
            </div>
        </section>

        <hr class="border-gray-700 my-8">

        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 border-l-4 border-cyan-400 pl-4">ä»»å‹™ 6ï¼šåœ¨ BigQuery ä¸­æª¢è¦–èˆ‡åˆ†ææ—¥èªŒ</h2>
            <p class="mb-4 text-gray-400">æ—¥èªŒå·²ç¶“é€é Sink é€²å…¥ BigQueryï¼Œç¾åœ¨è®“æˆ‘å€‘ä¾†çœ‹çœ‹æˆæœã€‚</p>
            <div class="space-y-4">
                <div>
                    <h3 class="text-xl font-semibold mb-2">1. å°‹æ‰¾æ—¥èªŒè³‡æ–™è¡¨</h3>
                    <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-300">
                        <li>å›åˆ° <strong>BigQuery</strong> ä»‹é¢ã€‚</li>
                        <li>åœ¨ <strong>Explorer</strong> é¢æ¿ä¸­ï¼Œå±•é–‹æ‚¨çš„å°ˆæ¡ˆåŠ <code>bq_logs</code> è³‡æ–™é›†ã€‚</li>
                        <li>æ‚¨æœƒçœ‹åˆ°ä¸€å€‹æ–°å»ºç«‹çš„è³‡æ–™è¡¨ï¼Œåç¨±é¡ä¼¼ <code>cloudaudit_googleapis_com_data_access_...</code>ã€‚</li>
                        <li class="text-amber-300"><strong>æ³¨æ„ï¼š</strong> æ—¥èªŒæ˜¯é€éä¸²æµæ–¹å¼å¯«å…¥çš„ï¼Œæ‰€ä»¥é»æ“Š <strong>Preview</strong> å¯èƒ½æš«æ™‚çœ‹ä¸åˆ°æœ€æ–°è³‡æ–™ï¼Œä½†è³‡æ–™å·²ç¶“å¯ä»¥è¢«æŸ¥è©¢ã€‚</li>
                    </ol>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">2. å»ºç«‹ VIEW ç°¡åŒ–è³‡æ–™</h3>
                    <p class="mb-4 text-gray-400">åŸå§‹çš„æ—¥èªŒè³‡æ–™è¡¨æ¬„ä½éå¸¸å¤šä¸”è¤‡é›œã€‚ç‚ºäº†æ–¹ä¾¿åˆ†æï¼Œæˆ‘å€‘å»ºç«‹ä¸€å€‹ <strong>VIEW (æª¢è¦–è¡¨)</strong> ä¾†æŠ½å–é‡è¦æ¬„ä½ä¸¦åšä¸€äº›åŸºæœ¬è¨ˆç®—ã€‚</p>
                    <ol class="list-decimal list-inside space-y-2 pl-4 mb-4 text-gray-300">
                        <li>é»æ“Š <strong>+ (Compose new query)</strong>ï¼Œè²¼ä¸Šä¸¦åŸ·è¡Œä»¥ä¸‹ SQLï¼š</li>
                    </ol>
                    <div class="bg-yellow-900/30 border border-yellow-600 text-yellow-300 px-4 py-3 rounded-lg relative mb-4" role="alert">
                      <strong class="font-bold">âš ï¸ é‡è¦æç¤ºï¼š</strong>
                      <span class="block sm:inline">è«‹å‹™å¿…å°‡ <code>Project ID</code> æ›¿æ›ç‚ºæ‚¨å¯¦é©—å®¤çš„<strong>å¯¦éš›å°ˆæ¡ˆ ID</strong>ã€‚</span>
                    </div>
                    <pre><code class="language-sql">CREATE OR REPLACE VIEW
  bq_logs.v_querylogs AS
SELECT
  resource.labels.project_id,
  protopayload_auditlog.authenticationInfo.principalEmail,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobConfiguration.query.query,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobConfiguration.query.statementType,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatus.error.message,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.startTime,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.endTime,
  TIMESTAMP_DIFF(protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.endTime, protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.startTime, MILLISECOND)/1000 AS run_seconds,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.totalProcessedBytes,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.totalSlotMs,
  ARRAY(SELECT as STRUCT datasetid, tableId FROM UNNEST(protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.referencedTables)) as tables_ref,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.totalTablesProcessed,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.queryOutputRowCount,
  severity
FROM
  `Project ID.bq_logs.cloudaudit_googleapis_com_data_access_*`
ORDER BY
  startTime</code></pre>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">3. æŸ¥è©¢ VIEW</h3>
                    <p class="mb-4 text-gray-400">ç¾åœ¨ï¼Œæ‚¨å¯ä»¥åƒæŸ¥è©¢ä¸€èˆ¬è³‡æ–™è¡¨ä¸€æ¨£ï¼ŒæŸ¥è©¢é€™å€‹ <code>v_querylogs</code> æª¢è¦–è¡¨äº†ã€‚æ’°å¯«ä¸€å€‹æ–°æŸ¥è©¢ä¸¦åŸ·è¡Œï¼š</p>
                    <pre><code>SELECT * FROM bq_logs.v_querylogs</code></pre>
                    <p class="mt-4 text-gray-300">åœ¨æŸ¥è©¢çµæœä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°è¢«æ•´ç†éçš„æ—¥èªŒï¼ŒåŒ…å«åŸ·è¡Œè€…ã€æŸ¥è©¢èªå¥ã€é–‹å§‹èˆ‡çµæŸæ™‚é–“ã€åŸ·è¡Œç§’æ•¸ç­‰å¯¦ç”¨è³‡è¨Šã€‚</p>
                </div>
            </div>
        </section>

        <footer class="text-center mt-12 py-6 border-t border-gray-700">
            <p class="text-lg font-semibold text-green-400">æ­å–œæ‚¨ï¼ğŸ‰</p>
            <p class="text-gray-400">æ‚¨å·²æˆåŠŸå»ºç«‹ä¸€å€‹è‡ªå‹•åŒ–çš„ BigQuery ä½¿ç”¨æƒ…æ³åˆ†ææµç¨‹ã€‚</p>
        </footer>

    </div>

    <script>
        // åˆå§‹åŒ– Mermaid.js
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });

        // ç‚ºæ‰€æœ‰ <pre> å€å¡ŠåŠ ä¸Šè¤‡è£½æŒ‰éˆ•
        document.querySelectorAll('pre').forEach(pre => {
            const code = pre.querySelector('code');
            if (code) {
                const button = document.createElement('button');
                button.innerText = 'è¤‡è£½';
                button.className = 'copy-btn';
                
                button.addEventListener('click', () => {
                    const textToCopy = code.innerText;
                    
                    // ä½¿ç”¨ Clipboard API
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        button.innerText = 'å·²è¤‡è£½!';
                        setTimeout(() => {
                            button.innerText = 'è¤‡è£½';
                        }, 2000);
                    }).catch(err => {
                        console.error('ç„¡æ³•è¤‡è£½æ–‡å­—: ', err);
                        // å‚™ç”¨æ–¹æ³•
                        const textArea = document.createElement('textarea');
                        textArea.value = textToCopy;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            button.innerText = 'å·²è¤‡è£½!';
                            setTimeout(() => {
                                button.innerText = 'è¤‡è£½';
                            }, 2000);
                        } catch (e) {
                            button.innerText = 'å¤±æ•—';
                        }
                        document.body.removeChild(textArea);
                    });
                });
                
                pre.appendChild(button);
            }
        });
    </script>

</body>
</html>
